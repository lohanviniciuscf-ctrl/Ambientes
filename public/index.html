<script>
/* ======================
   REFERÊNCIAS DE TELA
====================== */
const envSelect = document.getElementById("envSelect");
const loginScreen = document.getElementById("loginScreen");
const app = document.getElementById("app");
const envTitle = document.getElementById("envTitle");
const appTitle = document.getElementById("appTitle");
const loginError = document.getElementById("loginError");

/* ======================
   USUÁRIOS
====================== */
const users = {
  Lohan:{pass:"D9f0da85",env:["Modelle Skin","Cia & Arte"]},
  marcus:{pass:"Elistray6001",env:["Cia & Arte"]},
  Queila:{pass:"alieuq79",env:["Modelle Skin"]}
};

let currentEnv = localStorage.getItem("env");
let currentUser = localStorage.getItem("user");

/* ======================
   AMBIENTE
====================== */
function selectEnv(env){
  currentEnv = env;
  localStorage.setItem("env",env);

  // Tema
  if(env==="Modelle Skin"){
    document.documentElement.style.setProperty("--bg","#f3e0c8");
    document.documentElement.style.setProperty("--card","#e6c9a8");
    document.documentElement.style.setProperty("--accent","#8b5e3c");
  }else{
    document.documentElement.style.setProperty("--bg","#0a192f");
    document.documentElement.style.setProperty("--card","#112240");
    document.documentElement.style.setProperty("--accent","#64ffda");
  }

  envSelect.style.display="none";
  loginScreen.style.display="flex";
  app.style.display="none";
  envTitle.innerText=env;
}

/* ======================
   LOGIN
====================== */
function login(){
  const u=document.getElementById("user").value;
  const p=document.getElementById("pass").value;

  if(users[u] && users[u].pass===p && users[u].env.includes(currentEnv)){
    localStorage.setItem("user",u);
    showApp();
  }else{
    loginError.innerText="Usuário ou senha inválidos para este ambiente";
  }
}

function logout(){
  localStorage.clear();
  location.reload();
}

/* ======================
   TELA APP
====================== */
function showApp(){
  envSelect.style.display="none";
  loginScreen.style.display="none";
  app.style.display="block";
  appTitle.innerText=currentEnv+" — "+currentUser;
}

/* ======================
   ESTADO INICIAL
====================== */
if(currentEnv && currentUser){
  showApp();
}else if(currentEnv){
  envSelect.style.display="none";
  loginScreen.style.display="flex";
  envTitle.innerText=currentEnv;
}else{
  envSelect.style.display="flex";
}

/* ======================
   CRM
====================== */
const pipeline=["Lead","Em andamento","Proposta","Fechado"];
const board=document.getElementById("board");
const totalLeads=document.getElementById("totalLeads");
const faturamento=document.getElementById("faturamento");
const lucro=document.getElementById("lucro");

let leads=JSON.parse(localStorage.getItem(`crm_${currentEnv}_${currentUser}`))||[];

function save(){
  localStorage.setItem(`crm_${currentEnv}_${currentUser}`,JSON.stringify(leads));
}

function addLead(){
  const nome=document.getElementById("nome").value;
  const valor=+document.getElementById("valor").value;
  const custo=+document.getElementById("custo").value;

  if(!nome || !valor) return;

  leads.push({
    id:Date.now(),
    nome,valor,custo,
    status:pipeline[0],
    created:Date.now()
  });
  save();render();
}

function render(){
  board.innerHTML="";
  let fat=0,luc=0;

  pipeline.forEach(stage=>{
    const col=document.createElement("div");
    col.className="column";
    col.innerHTML=`<h3>${stage}</h3>`;
    col.ondragover=e=>e.preventDefault();
    col.ondrop=e=>{
      const id=e.dataTransfer.getData("id");
      leads.find(l=>l.id==id).status=stage;
      save();render();
    };

    leads.filter(l=>l.status===stage).forEach(l=>{
      fat+=l.valor;
      luc+=(l.valor-l.custo);

      const c=document.createElement("div");
      c.className="card";
      c.draggable=true;
      c.ondragstart=e=>e.dataTransfer.setData("id",l.id);
      c.innerHTML=`
        <strong>${l.nome}</strong><br>
        Valor: R$ ${l.valor}<br>
        Lucro: R$ ${l.valor-l.custo}<br>
        <small>Lead time: ${Math.floor((Date.now()-l.created)/86400000)} dias</small>
      `;
      col.appendChild(c);
    });

    board.appendChild(col);
  });

  totalLeads.innerText=leads.length;
  faturamento.innerText="R$ "+fat;
  lucro.innerText="R$ "+luc;
}

if(currentEnv && currentUser) render();
</script>
